"""
ğŸ‡ æœ‰é¦¬è¨˜å¿µäºˆæƒ³ã‚¢ãƒ—ãƒª 2025
GitHub Ã— Streamlit ã§å‹•ä½œã™ã‚‹ç«¶é¦¬äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ 
"""

import streamlit as st
import pandas as pd
from openai import OpenAI
import os
import html
import time
import requests
from typing import List, Dict

from datetime import datetime, timezone, timedelta
JST = timezone(timedelta(hours=9))



# ============================================
# ãƒšãƒ¼ã‚¸è¨­å®š
# ============================================
st.set_page_config(
    page_title="æœ‰é¦¬è¨˜å¿µäºˆæƒ³ 2025",
    page_icon="ğŸ‡",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# ============================================
# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ï¼ˆã‚¿ãƒ–åˆ‡æ›¿ã§ã‚‚çµæœã‚’ä¿æŒï¼‰
# ============================================
if "comp_results" not in st.session_state:
    st.session_state["comp_results"] = {"step1": None, "step2": None, "step3": None}
if "eval_results" not in st.session_state:
    st.session_state["eval_results"] = {}
if "sign_results" not in st.session_state:
    st.session_state["sign_results"] = {"events": None, "numbers": None, "bet": None}
if "search_results" not in st.session_state:
    st.session_state["search_results"] = None
if "search_date_jst" not in st.session_state:
    st.session_state["search_date_jst"] = None

# ============================================
# è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆç™½æ–‡å­—å•é¡Œã®æ ¹æœ¬å¯¾ç­–ï¼‰
# - LLMå‡ºåŠ›ã‚’Markdownã¨ã—ã¦è§£é‡ˆã•ã›ãšã€HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ç®±ã®ä¸­ã«å›ºå®š
# ============================================
def text_to_safe_html(text: str) -> str:
    if text is None:
        return ""
    s = html.escape(str(text))
    s = s.replace("\n", "<br>")
    s = s.replace("<br>- ", "<br>â€¢ ")
    if s.startswith("- "):
        s = "â€¢ " + s[2:]
    return s

def render_box(title: str, body_text: str, box_class: str = "result-box") -> str:
    body = text_to_safe_html(body_text)
    return f"""
    <div class="{box_class}">
      <div class="box-title">{html.escape(title)}</div>
      <div class="box-body">{body}</div>
    </div>
    """

# ============================================
# ã‚«ã‚¹ã‚¿ãƒ CSS
# ============================================
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');

    .stApp {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        font-family: 'Noto Sans JP', sans-serif;
    }

    /* åŸºæœ¬ãƒ†ã‚­ã‚¹ãƒˆã¯ç™½ */
    .stMarkdown, .stMarkdown p, .stMarkdown li, .stMarkdown span,
    h1, h2, h3, h4, h5, h6 {
        color: #ffffff !important;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ« */
    .main-title {
        font-size: 3rem;
        font-weight: 900;
        background: linear-gradient(135deg, #ffd700, #ff8c00);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        padding: 1rem 0;
    }
    .sub-title {
        font-size: 1.1rem;
        color: #e0e0e0 !important;
        text-align: center;
        margin-bottom: 2rem;
        letter-spacing: 0.2em;
    }

    /* æ©Ÿèƒ½èª¬æ˜ã‚«ãƒ¼ãƒ‰ */
    .feature-card {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 215, 0, 0.3);
        margin: 1rem 0;
    }
    .feature-card h3 { color: #ffd700 !important; }
    .feature-card p, .feature-card li { color: #e0e0e0 !important; }

    /* çµæœãƒœãƒƒã‚¯ã‚¹ï¼šé»’æ–‡å­—ã‚’100%ä¿è¨¼ */
    .result-box {
        background: #ffffff;
        border-radius: 12px;
        padding: 1.2rem 1.3rem;
        margin: 0.6rem 0;
        border-left: 5px solid #ffd700;
        box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        color: #111111 !important;
    }
    .analysis-box {
        background: #ffffff;
        border-radius: 12px;
        padding: 1rem 1.1rem;
        min-height: 280px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.20);
        color: #111111 !important;
    }
    .box-title{
        font-weight: 800;
        font-size: 1.05rem;
        margin-bottom: 0.6rem;
        color: #111111 !important;
    }
    .box-body{
        font-size: 0.98rem;
        line-height: 1.7;
        color: #111111 !important;
        white-space: normal;
        word-break: break-word;
    }

    .box-horse { border: 3px solid #e74c3c; }
    .box-jockey { border: 3px solid #3498db; }
    .box-course { border: 3px solid #27ae60; }
    .box-total { border: 3px solid #f39c12; background: #fffef5; }
    .box-events { border: 3px solid #9b59b6; }
    .box-numbers { border: 3px solid #e67e22; }
    .box-buy { border: 3px solid #c0392b; background: #fff8f8; }

    /* ãƒ©ãƒ™ãƒ« */
    .label {
        font-size: 1.05rem;
        font-weight: 800;
        padding: 0.45rem 1rem;
        border-radius: 8px;
        margin-bottom: 0.8rem;
        text-align: center;
        color: #ffffff !important;
        display: inline-block;
        width: 100%;
    }
    .label-horse { background: #e74c3c; }
    .label-jockey { background: #3498db; }
    .label-course { background: #27ae60; }
    .label-total { background: #f39c12; }
    .label-step1 { background: #2c3e50; }
    .label-step2 { background: #34495e; }
    .label-step3 { background: #7f8c8d; }
    .label-events { background: #9b59b6; }
    .label-numbers { background: #e67e22; }
    .label-buy { background: #c0392b; }

    /* ãƒœã‚¿ãƒ³ */
    .stButton > button {
        background: linear-gradient(135deg, #ffd700, #ff8c00) !important;
        color: #1a1a2e !important;
        font-weight: 800;
        font-size: 1.1rem;
        padding: 0.7rem 2rem;
        border-radius: 50px;
        border: none;
    }
    .stButton > button:hover {
        transform: scale(1.03);
        box-shadow: 0 8px 25px rgba(255, 215, 0, 0.35);
    }

    /* ã‚¿ãƒ– */
    .stTabs [data-baseweb="tab"] {
        background: rgba(255,255,255,0.15);
        color: #ffffff !important;
        font-weight: 700;
    }
    .stTabs [aria-selected="true"] {
        background: linear-gradient(135deg, #ffd700, #ff8c00) !important;
        color: #1a1a2e !important;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    section[data-testid="stSidebar"] {
        background: linear-gradient(180deg, #1a1a2e, #0f3460);
    }
    section[data-testid="stSidebar"] .stMarkdown { color: #ffffff !important; }

    /* Selectbox æ–‡å­—ã‚’é»’ */
    div[data-baseweb="select"] * { color: #000000 !important; }

    /* info/success/warning ã®æ–‡å­—ã‚’ç™½ï¼ˆæš—ã„èƒŒæ™¯ã§è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰ */
    div[data-testid="stAlert"] * { color: #ffffff !important; }
</style>
""", unsafe_allow_html=True)

# st.markdown("""
# <style>
# /* 1) ãƒ˜ãƒƒãƒ€ãƒ¼/ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãŒèƒŒé¢ã«å›ã£ã¦ã„ã‚‹ã¨ãƒˆã‚°ãƒ«ã‚‚æ¶ˆãˆã‚‹ã®ã§æœ€å‰é¢åŒ– */
# [data-testid="stHeader"],
# header,
# .stApp > header {
#   z-index: 999998 !important;
#   position: relative !important;
#   display: block !important;
#   visibility: visible !important;
#   opacity: 1 !important;
# }

# /* 2) ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ãƒˆã‚°ãƒ«ï¼ˆæ—§/æ–°ã®ä¸¡æ–¹ã‚’æƒ³å®šã—ã¦å…¨éƒ¨æ‹¾ã†ï¼‰ */
# [data-testid="collapsedControl"],
# [data-testid="stSidebarCollapsedControl"],
# [data-testid="stSidebarCollapseButton"],
# button[aria-label="Close sidebar"],
# button[aria-label="Open sidebar"]{
#   display: inline-flex !important;
#   visibility: visible !important;
#   opacity: 1 !important;
#   pointer-events: auto !important;
#   z-index: 999999 !important;
# }

# /* 3) ãƒˆã‚°ãƒ«ãŒèƒŒæ™¯ã«åŸ‹ã‚‚ã‚Œã‚‹å•é¡ŒãŒå¤šã„ã®ã§å›ºå®šé…ç½®ã§å¼·åˆ¶è¡¨ç¤º */
# [data-testid="collapsedControl"],
# [data-testid="stSidebarCollapsedControl"]{
#   position: fixed !important;
#   top: 0.75rem !important;
#   left: 0.75rem !important;
# }

# /* 4) ãƒœã‚¿ãƒ³ãŒâ€œè¦‹ãˆã¦ã‚‹ã®ã«è¦‹ãˆãªã„â€å¯¾ç­–ï¼ˆè‰²/èƒŒæ™¯/å½±ï¼‰ */
# [data-testid="collapsedControl"] *,
# [data-testid="stSidebarCollapsedControl"] *,
# [data-testid="stSidebarCollapseButton"] *,
# button[aria-label="Close sidebar"] *,
# button[aria-label="Open sidebar"] *{
#   color: #ffffff !important;
# }

# [data-testid="collapsedControl"],
# [data-testid="stSidebarCollapsedControl"],
# [data-testid="stSidebarCollapseButton"],
# button[aria-label="Close sidebar"],
# button[aria-label="Open sidebar"]{
#   background: rgba(0,0,0,0.35) !important;
#   border-radius: 10px !important;
#   box-shadow: 0 4px 14px rgba(0,0,0,0.35) !important;
# }
# </style>
# """, unsafe_allow_html=True)



# ============================================
# OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
# ============================================
def get_openai_client():
    api_key = st.secrets.get("OPENAI_API_KEY", os.environ.get("OPENAI_API_KEY"))
    if not api_key:
        st.error("âš ï¸ OpenAI API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return None
    return OpenAI(api_key=api_key)

# ============================================
# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
# ============================================
@st.cache_data
def load_race_data(uploaded_file=None):
    try:
        if uploaded_file is not None:
            xlsx = pd.ExcelFile(uploaded_file)
        else:
            xlsx = pd.ExcelFile("arima_data.xlsx")
        data = {}
        for sheet in xlsx.sheet_names:
            data[sheet] = pd.read_excel(xlsx, sheet_name=sheet)
        return data
    except Exception:
        return None

def format_data_for_prompt(data):
    if data is None:
        return "ãƒ‡ãƒ¼ã‚¿ãªã—"
    formatted = ""
    sheets = ["å¹´é½¢", "æ é †", "é¨æ‰‹", "è¡€çµ±", "å‰èµ°ã‚¯ãƒ©ã‚¹", "å‰èµ°ãƒ¬ãƒ¼ã‚¹åˆ¥", "é¦¬ä½“é‡å¢—æ¸›"]
    titles = ["å¹´é½¢åˆ¥æœŸå¾…å€¤", "æ é †åˆ¥æœŸå¾…å€¤", "é¨æ‰‹åˆ¥æœŸå¾…å€¤ï¼ˆä¸­å±±2500mï¼‰", "è¡€çµ±ï¼ˆç¨®ç‰¡é¦¬ï¼‰åˆ¥æœŸå¾…å€¤",
              "å‰èµ°ã‚¯ãƒ©ã‚¹åˆ¥æœŸå¾…å€¤", "å‰èµ°ãƒ¬ãƒ¼ã‚¹åˆ¥æœŸå¾…å€¤", "é¦¬ä½“é‡å¢—æ¸›åˆ¥æœŸå¾…å€¤"]
    for sheet, title in zip(sheets, titles):
        if sheet in data:
            formatted += f"ã€{title}ã€‘\n{data[sheet].to_string(index=False)}\n\n"
    return formatted

# ============================================
# 2025å¹´æœ‰é¦¬è¨˜å¿µ å‡ºèµ°äºˆå®šé¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆæ é †æœªç¢ºå®šï¼‰
# ============================================
HORSE_LIST_2025 = {
    1: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ãƒ¬ã‚¬ãƒ¬ã‚¤ãƒ©", "æ€§é½¢": "ç‰4æ­³", "é¨æ‰‹": "C.ãƒ«ãƒ¡ãƒ¼ãƒ«", "è¡€çµ±": "ã‚¹ãƒ¯ãƒ¼ãƒ´ãƒªãƒãƒ£ãƒ¼ãƒ‰", "å‰èµ°": "ã‚¨ãƒªã‚¶ãƒ™ã‚¹å¥³ç‹æ¯1ç€"},
    2: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ãƒã‚¤ãƒ«", "æ€§é½¢": "ç‰¡3æ­³", "é¨æ‰‹": "C.ãƒ‡ãƒ ãƒ¼ãƒ­", "è¡€çµ±": "ãƒªã‚ªãƒ³ãƒ‡ã‚£ãƒ¼ã‚º", "å‰èµ°": "å¤©çš‡è³ç§‹2ç€"},
    3: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ãƒ€ãƒãƒ³ãƒ‡ã‚µã‚¤ãƒ«", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "æˆ¸å´åœ­å¤ª", "è¡€çµ±": "ã‚¨ãƒ”ãƒ•ã‚¡ãƒã‚¤ã‚¢", "å‰èµ°": "JC3ç€"},
    4: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ãƒ¡ã‚¤ã‚·ãƒ§ã‚¦ã‚¿ãƒãƒ«", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "æ­¦è±Š", "è¡€çµ±": "ã‚´ãƒ¼ãƒ«ãƒ‰ã‚·ãƒƒãƒ—", "å‰èµ°": "å¤©çš‡è³ç§‹6ç€"},
    5: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ãƒ“ã‚¶ãƒ³ãƒãƒ³ãƒ‰ãƒªãƒ¼ãƒ ", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "A.ãƒ—ãƒ¼ã‚·ãƒ£ãƒ³", "è¡€çµ±": "ã‚¨ãƒ”ãƒ•ã‚¡ãƒã‚¤ã‚¢", "å‰èµ°": "å‡±æ—‹é–€è³5ç€"},
    6: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚¸ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ãƒ‘ãƒ¬ã‚¹", "æ€§é½¢": "ç‰¡6æ­³", "é¨æ‰‹": "å›£é‡å¤§æˆ", "è¡€çµ±": "ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ", "å‰èµ°": "JC5ç€"},
    7: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚·ãƒ³ã‚¨ãƒ³ãƒšãƒ©ãƒ¼", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "å‚äº•ç‘ æ˜Ÿ", "è¡€çµ±": "Siyouni", "å‰èµ°": "JC8ç€"},
    8: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚¿ã‚¹ãƒ†ã‚£ã‚¨ãƒ¼ãƒ©", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "æ¾å±±å¼˜å¹³", "è¡€çµ±": "ã‚µãƒˆãƒã‚¯ãƒ©ã‚¦ãƒ³", "å‰èµ°": "JC7ç€"},
    9: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚³ã‚¹ãƒ¢ã‚­ãƒ¥ãƒ©ãƒ³ãƒ€", "æ€§é½¢": "ç‰¡3æ­³", "é¨æ‰‹": "ä¸¹å†…ç¥æ¬¡", "è¡€çµ±": "ã‚¢ãƒ«ã‚¢ã‚¤ãƒ³", "å‰èµ°": "JC9ç€"},
    10: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚¢ãƒ‰ãƒã‚¤ãƒ¤ãƒ†ãƒ©", "æ€§é½¢": "ç‰¡3æ­³", "é¨æ‰‹": "å·ç”°å°†é›…", "è¡€çµ±": "ã‚¹ãƒ¯ãƒ¼ãƒ´ãƒªãƒãƒ£ãƒ¼ãƒ‰", "å‰èµ°": "èŠèŠ±è³3ç€"},
    11: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚µãƒ³ãƒ©ã‚¤ã‚ºã‚¢ãƒ¼ã‚¹", "æ€§é½¢": "ç‰¡3æ­³", "é¨æ‰‹": "æ± æ·»è¬™ä¸€", "è¡€çµ±": "ãƒ¬ã‚¤ãƒ‡ã‚ªãƒ­", "å‰èµ°": "JC15ç€"},
    12: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚¨ãƒ«ãƒˆãƒ³ãƒãƒ­ãƒ¼ã‚º", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "è¥¿æ‘æ·³ä¹Ÿ", "è¡€çµ±": "ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ–ãƒªãƒ©ãƒ³ãƒ†", "å‰èµ°": "å¤©çš‡è³ç§‹9ç€"},
    13: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚¦ã‚§ã‚¤", "æ€§é½¢": "ç‰¡5æ­³", "é¨æ‰‹": "æ¾æœ¬å¤§è¼", "è¡€çµ±": "ãƒãƒ¼ãƒ„ã‚¯ãƒ©ã‚¤", "å‰èµ°": "ARC1ç€"},
    14: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚µãƒ³ãƒ©ã‚¤ã‚ºã‚¸ãƒ‘ãƒ³ã‚°", "æ€§é½¢": "ç‰¡3æ­³", "é¨æ‰‹": "æœªå®š", "è¡€çµ±": "ã‚­ã‚¿ã‚µãƒ³ãƒ–ãƒ©ãƒƒã‚¯", "å‰èµ°": "ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã‚ºC6ç€"},
    15: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ãƒ˜ãƒ‡ãƒ³ãƒˆãƒ¼ãƒ«", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "æœªå®š", "è¡€çµ±": "ãƒãƒ¼ãƒ“ãƒ³ã‚¸ãƒ£ãƒ¼", "å‰èµ°": "å¤©çš‡è³ç§‹10ç€"},
    16: {"æ ç•ª": 0, "é¦¬ç•ª": 0, "é¦¬å": "ã‚·ãƒ¥ãƒ´ã‚¡ãƒªã‚¨ãƒ­ãƒ¼ã‚º", "æ€§é½¢": "ç‰¡4æ­³", "é¨æ‰‹": "æœªå®š", "è¡€çµ±": "ã‚­ã‚ºãƒŠ", "å‰èµ°": "å®å¡šè¨˜å¿µ4ç€"},
}


HORSE_INFO_STR_2025 = """ã€2025å¹´æœ‰é¦¬è¨˜å¿µ å‡ºèµ°äºˆå®šé¦¬ã€‘â€»æ é †ãƒ»é¦¬ç•ªæœªç¢ºå®š
æ 0ãƒ»é¦¬0ï½œãƒ¬ã‚¬ãƒ¬ã‚¤ãƒ©ï¼ˆç‰4æ­³ãƒ»C.ãƒ«ãƒ¡ãƒ¼ãƒ«ãƒ»ã‚¹ãƒ¯ãƒ¼ãƒ´ãƒªãƒãƒ£ãƒ¼ãƒ‰ç”£é§’ãƒ»å‰èµ°ã‚¨ãƒªã‚¶ãƒ™ã‚¹å¥³ç‹æ¯1ç€ï¼‰- ãƒ•ã‚¡ãƒ³æŠ•ç¥¨1ä½ãƒ»é€£è¦‡ç‹™ã„
æ 0ãƒ»é¦¬0ï½œãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ãƒã‚¤ãƒ«ï¼ˆç‰¡3æ­³ãƒ»C.ãƒ‡ãƒ ãƒ¼ãƒ­ãƒ»ãƒªã‚ªãƒ³ãƒ‡ã‚£ãƒ¼ã‚ºç”£é§’ãƒ»å‰èµ°å¤©çš‡è³ç§‹2ç€ï¼‰- çšæœˆè³é¦¬
æ 0ãƒ»é¦¬0ï½œãƒ€ãƒãƒ³ãƒ‡ã‚µã‚¤ãƒ«ï¼ˆç‰¡4æ­³ãƒ»æˆ¸å´åœ­å¤ªãƒ»ã‚¨ãƒ”ãƒ•ã‚¡ãƒã‚¤ã‚¢ç”£é§’ãƒ»å‰èµ°JC3ç€ï¼‰- ãƒ€ãƒ¼ãƒ“ãƒ¼é¦¬ãƒ»æ˜¨å¹´3ç€
æ 0ãƒ»é¦¬0ï½œãƒ¡ã‚¤ã‚·ãƒ§ã‚¦ã‚¿ãƒãƒ«ï¼ˆç‰¡4æ­³ãƒ»æ­¦è±Šãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰ã‚·ãƒƒãƒ—ç”£é§’ãƒ»å‰èµ°å¤©çš‡è³ç§‹6ç€ï¼‰- å®å¡šè¨˜å¿µé¦¬ãƒ»æ˜¥ç§‹GPåˆ¶è¦‡ç‹™ã„
æ 0ãƒ»é¦¬0ï½œãƒ“ã‚¶ãƒ³ãƒãƒ³ãƒ‰ãƒªãƒ¼ãƒ ï¼ˆç‰¡4æ­³ãƒ»A.ãƒ—ãƒ¼ã‚·ãƒ£ãƒ³ãƒ»ã‚¨ãƒ”ãƒ•ã‚¡ãƒã‚¤ã‚¢ç”£é§’ãƒ»å‰èµ°å‡±æ—‹é–€è³5ç€ï¼‰- æµ·å¤–å¸°ã‚Š
æ 0ãƒ»é¦¬0ï½œã‚¸ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ãƒ‘ãƒ¬ã‚¹ï¼ˆç‰¡6æ­³ãƒ»å›£é‡å¤§æˆãƒ»ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç”£é§’ãƒ»å‰èµ°JC5ç€ï¼‰- å¤©çš‡è³æ˜¥é¦¬ãƒ»ãƒ©ã‚¹ãƒˆãƒ©ãƒ³
æ 0ãƒ»é¦¬0ï½œã‚·ãƒ³ã‚¨ãƒ³ãƒšãƒ©ãƒ¼ï¼ˆç‰¡4æ­³ãƒ»å‚äº•ç‘ æ˜Ÿãƒ»Siyouniç”£é§’ãƒ»å‰èµ°JC8ç€ï¼‰- çšæœˆè³2ç€
æ 0ãƒ»é¦¬0ï½œã‚¿ã‚¹ãƒ†ã‚£ã‚¨ãƒ¼ãƒ©ï¼ˆç‰¡4æ­³ãƒ»æ¾å±±å¼˜å¹³ãƒ»ã‚µãƒˆãƒã‚¯ãƒ©ã‚¦ãƒ³ç”£é§’ãƒ»å‰èµ°JC7ç€ï¼‰- æ˜¨å¹´ãƒ€ãƒ¼ãƒ“ãƒ¼é¦¬
æ 0ãƒ»é¦¬0ï½œã‚³ã‚¹ãƒ¢ã‚­ãƒ¥ãƒ©ãƒ³ãƒ€ï¼ˆç‰¡3æ­³ãƒ»ä¸¹å†…ç¥æ¬¡ãƒ»ã‚¢ãƒ«ã‚¢ã‚¤ãƒ³ç”£é§’ãƒ»å‰èµ°JC9ç€ï¼‰- çšæœˆè³2ç€
æ 0ãƒ»é¦¬0ï½œã‚¢ãƒ‰ãƒã‚¤ãƒ¤ãƒ†ãƒ©ï¼ˆç‰¡3æ­³ãƒ»å·ç”°å°†é›…ãƒ»ã‚¹ãƒ¯ãƒ¼ãƒ´ãƒªãƒãƒ£ãƒ¼ãƒ‰ç”£é§’ãƒ»å‰èµ°èŠèŠ±è³3ç€ï¼‰
æ 0ãƒ»é¦¬0ï½œã‚µãƒ³ãƒ©ã‚¤ã‚ºã‚¢ãƒ¼ã‚¹ï¼ˆç‰¡3æ­³ãƒ»æ± æ·»è¬™ä¸€ãƒ»ãƒ¬ã‚¤ãƒ‡ã‚ªãƒ­ç”£é§’ãƒ»å‰èµ°JC15ç€ï¼‰
æ 0ãƒ»é¦¬0ï½œã‚¨ãƒ«ãƒˆãƒ³ãƒãƒ­ãƒ¼ã‚ºï¼ˆç‰¡4æ­³ãƒ»è¥¿æ‘æ·³ä¹Ÿãƒ»ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ–ãƒªãƒ©ãƒ³ãƒ†ç”£é§’ãƒ»å‰èµ°å¤©çš‡è³ç§‹9ç€ï¼‰
æ 0ãƒ»é¦¬0ï½œãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚¦ã‚§ã‚¤ï¼ˆç‰¡5æ­³ãƒ»æ¾æœ¬å¤§è¼ãƒ»ãƒãƒ¼ãƒ„ã‚¯ãƒ©ã‚¤ç”£é§’ãƒ»å‰èµ°ARC1ç€ï¼‰- ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³å…±å’Œå›½æ¯å‹ã¡
æ 0ãƒ»é¦¬0ï½œã‚µãƒ³ãƒ©ã‚¤ã‚ºã‚¸ãƒ‘ãƒ³ã‚°ï¼ˆç‰¡3æ­³ãƒ»æœªå®šãƒ»ã‚­ã‚¿ã‚µãƒ³ãƒ–ãƒ©ãƒƒã‚¯ç”£é§’ãƒ»å‰èµ°ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã‚ºC6ç€ï¼‰
æ 0ãƒ»é¦¬0ï½œãƒ˜ãƒ‡ãƒ³ãƒˆãƒ¼ãƒ«ï¼ˆç‰¡4æ­³ãƒ»æœªå®šãƒ»ãƒãƒ¼ãƒ“ãƒ³ã‚¸ãƒ£ãƒ¼ç”£é§’ãƒ»å‰èµ°å¤©çš‡è³ç§‹10ç€ï¼‰
æ 0ãƒ»é¦¬0ï½œã‚·ãƒ¥ãƒ´ã‚¡ãƒªã‚¨ãƒ­ãƒ¼ã‚ºï¼ˆç‰¡4æ­³ãƒ»æœªå®šãƒ»ã‚­ã‚ºãƒŠç”£é§’ãƒ»å‰èµ°å®å¡šè¨˜å¿µ4ç€ï¼‰
"""


EVENTS_2025_STR = """ã€2025å¹´ã®ä¸»ãªå‡ºæ¥äº‹ã€‘
â–  å›½å®¶ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ç¤¾ä¼šï¼ˆå›å¸°ãƒ»å‘¨æœŸï¼‰
- å¤§é˜ªãƒ»é–¢è¥¿ä¸‡åšï¼ˆEXPO 2025ï¼‰
   - å†…å®¹: 1970å¹´ã®å¤§é˜ªä¸‡åšã‹ã‚‰55å¹´ã¶ã‚Šã€2005å¹´æ„›çŸ¥ã‹ã‚‰20å¹´ã¶ã‚Šã®é–‹å‚¬
   - é–¢é€£æ•°å­—: 55 (å¤§é˜ªé–‹å‚¬55å¹´ã¶ã‚Š), 1970 (å‰å›å¤§é˜ª), 4 (4æœˆé–‹å¹•), 10ï¼ˆ10æœˆé–‰å¹•ï¼‰, 13(é–‹å¹•æ—¥/é–‰å¹•æ—¥)

- æ–°ç´™å¹£ ç™ºè¡Œã‹ã‚‰1å¹´
   - å†…å®¹: 2024å¹´7æœˆã®ç™ºè¡Œã‹ã‚‰1å¹´ãŒçµŒéã—å®šç€
   - é–¢é€£æ•°å­—: 1 (1å‘¨å¹´), 24 (2024å¹´), 7 (7æœˆ)

â–  ã‚¹ãƒãƒ¼ãƒ„ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå›æ•°ãƒ»è¨˜éŒ²ï¼‰
- ç¬¬101å› ç®±æ ¹é§…ä¼
   - å†…å®¹: 101å›å¤§ä¼š
   - é–¢é€£æ•°å­—: 101 (ç¬¬101å›), 2 (1æœˆ2æ—¥), 3 (1æœˆ3æ—¥)

- ä¸–ç•Œé™¸ä¸Šç«¶æŠ€é¸æ‰‹æ¨©å¤§ä¼šï¼ˆæ±äº¬å¤§ä¼šï¼‰
   - å†…å®¹: æ±äº¬ã§34å¹´ã¶ã‚Šï¼ˆ1991å¹´ä»¥æ¥ï¼‰ã®é–‹å‚¬
   - é–¢é€£æ•°å­—: 34 (34å¹´ã¶ã‚Š), 91 (å‰å›1991å¹´), 20 (ç¬¬20å›å¤§ä¼š)

- ãƒ‰ã‚¸ãƒ£ãƒ¼ã‚¹å¤§è°·ç¿”å¹³ ãƒ¡ã‚¸ãƒ£ãƒ¼8å¹´ç›®
   - å†…å®¹: 2018å¹´ã®ã‚¨ãƒ³ã‚¼ãƒ«ã‚¹å…¥å›£ã‹ã‚‰æ•°ãˆã¦8å¹´ç›®ã®ã‚·ãƒ¼ã‚ºãƒ³
   - é–¢é€£æ•°å­—: 8 (8å¹´ç›®), 17 (èƒŒç•ªå·), 18 (2018å¹´ãƒ‡ãƒ“ãƒ¥ãƒ¼)

â–  ã‚²ãƒ¼ãƒ ãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ï¼ˆé–“éš”ãƒ»é€²åŒ–ï¼‰
- Nintendo Switch å¾Œç¶™æ©Ÿï¼ˆã‚¹ã‚¤ãƒƒãƒ2ï¼‰ã®è©±é¡Œ
   - å†…å®¹: 2017å¹´ã®Switchç™ºå£²ã‹ã‚‰8å¹´ã¶ã‚Šã«æŠ•å…¥ã•ã‚Œã‚‹æ¬¡ä¸–ä»£ãƒãƒ¼ãƒ‰
   - é–¢é€£æ•°å­—: 8 (8å¹´ã¶ã‚Šã®æ–°å‹æ©Ÿ), 2 (2ä¸–ä»£ç›®), 17 (å‰ä½œ2017å¹´)

- ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒªã‚ªãƒ–ãƒ©ã‚¶ãƒ¼ã‚º 40å‘¨å¹´
   - å†…å®¹: 1985å¹´ã®ãƒ•ã‚¡ãƒŸã‚³ãƒ³ç‰ˆç™ºå£²ã‹ã‚‰40å¹´
   - é–¢é€£æ•°å­—: 40 (ç™ºå£²40å‘¨å¹´), 85 (1985å¹´), 13 (9æœˆ13æ—¥ç™ºå£²)

- iPhone 17 ã‚·ãƒªãƒ¼ã‚ºç™ºå£²
   - å†…å®¹: æ¯å¹´æ’ä¾‹ã®æ–°å‹iPhoneç™ºå£²
   - é–¢é€£æ•°å­—: 17 (ã‚·ãƒªãƒ¼ã‚ºç•ªå·), 9 (ä¾‹å¹´ã®9æœˆç™ºå£²)

â–  ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ»æ–½è¨­ï¼ˆæ–°ä½œãƒ»é–‹æ¥­ï¼‰
- æ˜ ç”»ã€ŒãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼šã‚¤ãƒ³ãƒãƒƒã‚·ãƒ–ãƒ«ã€ç¬¬8ä½œå…¬é–‹
   - å†…å®¹: ã‚·ãƒªãƒ¼ã‚ºç¬¬8ä½œç›®ã«ã—ã¦æœ€çµ‚ç« ã¨ã•ã‚Œã‚‹ä½œå“
   - é–¢é€£æ•°å­—: 8 (ç¬¬8ä½œ), 23 (2025å¹´5æœˆ23æ—¥å…¬é–‹äºˆå®š)

- æ˜ ç”»ã€Œãƒãƒƒã‚¯ãƒ»ãƒˆã‚¥ãƒ»ã‚¶ãƒ»ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼ã€å…¬é–‹40å‘¨å¹´
   - å†…å®¹: 1985å¹´å…¬é–‹ã®åä½œã‹ã‚‰40å¹´
   - é–¢é€£æ•°å­—: 40 (å…¬é–‹40å‘¨å¹´), 85 (1985å¹´)

- NHKé€£ç¶šãƒ†ãƒ¬ãƒ“å°èª¬ã€Œã‚ã‚“ã±ã‚“ã€
   - å†…å®¹: ç¬¬112ä½œç›®ã®æœãƒ‰ãƒ©
   - é–¢é€£æ•°å­—: 112 (ç¬¬112ä½œ), 3 (ã‚¢ãƒ³ãƒ‘ãƒ³ãƒãƒ³ã®é ¬ã‚„æœã®è‰²)

- NHKå¤§æ²³ãƒ‰ãƒ©ãƒã€Œã¹ã‚‰ã¼ã†ã€
   - å†…å®¹: ç¬¬64ä½œç›®ã®å¤§æ²³ãƒ‰ãƒ©ãƒ
   - é–¢é€£æ•°å­—: 64 (ç¬¬64ä½œ), 1 (1æœˆæ”¾é€é–‹å§‹)
"""

search_query = """
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã®ä¸€æ¬¡æƒ…å ±ã‚’èª¿æŸ»ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã«ã¤ã„ã¦ã€WEBæ¤œç´¢ã‚’è¡Œã„ã€äº‹å®Ÿãƒ™ãƒ¼ã‚¹ã§æ•´ç†ã—ã¦ãã ã•ã„ã€‚

ã€èª¿æŸ»å¯¾è±¡ã€‘
- 2025å¹´ æœ‰é¦¬è¨˜å¿µ
- å‡ºèµ°äºˆå®šé¦¬
- æ é †ã®ç¢ºå®šçŠ¶æ³
- é¨æ‰‹ã®ç¢ºå®šçŠ¶æ³
- å…¬å¼ç™ºè¡¨ãƒ»ä¸€æ¬¡æƒ…å ±

ã€å‡ºåŠ›è¦ä»¶ã€‘
- JRAãƒ»ä¸»å‚¬è€…ãƒ»å…¬å¼æƒ…å ±ã‚’æœ€å„ªå…ˆ
- æ¨æ¸¬ãƒ»äºˆæƒ³ãƒ»ä¸»è¦³ã¯å«ã‚ãªã„
- ç¢ºå®šæƒ…å ± / æœªç¢ºå®šæƒ…å ± ã‚’åˆ†ã‘ã‚‹
- ç®‡æ¡æ›¸ãã§20é …ç›®ä»¥ä¸Š
- é‡è¦åº¦é †ã«æ•´ç†
"""

# ============================================
# Webæ¤œç´¢æ©Ÿèƒ½
# ============================================
def gpt_web_search(client, prompt: str) -> str:
    response = client.responses.create(
        model="gpt-4.1",
        tools=[{"type": "web_search"}],
        input=prompt,              # â† search_query ã‚’ãã®ã¾ã¾å…¥ã‚Œã‚‹
        max_output_tokens=3000,     # å‡ºåŠ›é‡åˆ¶å¾¡
    )
    return response.output_text


def ensure_daily_gpt_search(client, query: str) -> str:
    """
    tab1/2/3ã®ã©ã“ã‹ã‚‰å‘¼ã°ã‚Œã¦ã‚‚ã€
    JSTã§ã€Œãã®æ—¥1å›ã€ã ã‘ GPTæ¤œç´¢ã‚’å®Ÿè¡Œã—ã€çµæœã‚’ session_state ã«ä¿å­˜ã—ã¦è¿”ã™ã€‚
    """
    if client is None:
        return None

    today = datetime.now(JST).date().isoformat()

    # ã™ã§ã«ä»Šæ—¥ã®åˆ†ãŒã‚ã‚Œã°å†åˆ©ç”¨
    if st.session_state.get("search_date_jst") == today and st.session_state.get("search_results"):
        return st.session_state["search_results"]

    # ä»Šæ—¥ã®åˆ†ãŒãªã‘ã‚Œã°å®Ÿè¡Œ
    resp = gpt_web_search(client, query)
    text = getattr(resp, "output_text", None)
    if not text:
        text = str(resp)

    st.session_state["search_results"] = text
    st.session_state["search_date_jst"] = today
    return text

# ============================================
# æ©Ÿèƒ½â‘ : ç·åˆäºˆæƒ³ï¼ˆ3æ®µéšï¼‰
# ============================================
def analyze_data_summary(client, data):
    search_results = st.session_state.get("search_results") or "ï¼ˆWEBæ¤œç´¢çµæœãªã—ï¼‰"
    system_prompt = """
## æŒ‡ç¤º
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã‚’å°‚é–€ã¨ã™ã‚‹ç«¶é¦¬äºˆæƒ³AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
éå»ã®æœ‰é¦¬è¨˜å¿µãƒ‡ãƒ¼ã‚¿ã¨WEBä¸€æ¬¡æƒ…å ±ã‚’ã‚‚ã¨ã«å‚¾å‘ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

## ä½¿ç”¨ã™ã¹ãæƒ…å ±æº
- JRA/ä¸»å‚¬è€…ã€å…¬å¼å‡ºèµ°è¡¨ãƒ»å…¬å¼çµæœã€ä¿¡é ¼ã§ãã‚‹å‡ºèµ°ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆäº‹å®Ÿæƒ…å ±ï¼‰
- å‚ç…§ãƒ‡ãƒ¼ã‚¿

## å‚ç…§ãƒ‡ãƒ¼ã‚¿
ãƒ•ã‚¡ã‚¤ãƒ«åï¼šæœ‰é¦¬è¨˜å¿µéå»ãƒ‡ãƒ¼ã‚¿
ã€€- å¹´é½¢ï¼šå¹´é½¢Ã—ç€é †å‰²åˆ
ã€€- æ é †ï¼šæ ç•ªÃ—ç€é †å‰²åˆ
ã€€- é¨æ‰‹ï¼šé¨æ‰‹åˆ¥ç€é †å‰²åˆ
ã€€- è¡€çµ±ï¼šç¨®ç‰¡é¦¬åˆ¥ã®æœ‰é¦¬è¨˜å¿µç€é †å‰²åˆ
ã€€- å‰èµ°ãƒ¬ãƒ¼ã‚¹åˆ¥ï¼šå‰èµ°ãƒ¬ãƒ¼ã‚¹åˆ¥ã®ç€é †å‰²åˆ
ã€€- é¦¬ä½“é‡å¢—æ¸›ï¼šå¢—æ¸›å¹…åŒºåˆ†Ã—ç€é †å‰²åˆ

## å‚¾å‘åˆ†æãƒ•ãƒ­ãƒ¼
### STEP1 ãƒ¬ãƒ¼ã‚¹ã®è¦‹ç«‹ã¦æ•´ç†
é€ƒã’ãƒ»å…ˆè¡Œé¦¬ã®é ­æ•°ã¨è„šè³ªåˆ†å¸ƒã‹ã‚‰ã€
ãƒ¬ãƒ¼ã‚¹å…¨ä½“ã®ãƒšãƒ¼ã‚¹ã‚’ä»¥ä¸‹3æ®µéšã§åˆ¤å®šã™ã‚‹ã€‚
ã“ã“ã§æ§‹ç¯‰ã—ãŸå†…å®¹ã¯ã€ä¼šè©±ä¸­ã«ãƒ–ãƒ¬ã•ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã€‚

- Sï¼ˆã‚¹ãƒ­ãƒ¼ï¼‰
- Mï¼ˆãƒŸãƒ‰ãƒ«ï¼‰
- Hï¼ˆãƒã‚¤ï¼‰
â€»ãƒšãƒ¼ã‚¹åˆ¤å®šã®æ ¹æ‹ ã‚’1è¡Œã§ç¤ºã™ã€‚

### STEP2 éå»ãƒ‡ãƒ¼ã‚¿å‚¾å‘
ä»¥ä¸‹ã‚’å€‹åˆ¥è©•ä¾¡ã—å‚¾å‘ã‚’å‡ºåŠ›ã™ã‚‹  
ã€€ãƒ»å¹´é½¢  
ã€€ãƒ»æ é †  
ã€€ãƒ»å‰èµ°ãƒ¬ãƒ¼ã‚¹  
ã€€ãƒ»è¡€çµ±  
ã€€ãƒ»é¨æ‰‹  
ã€€ãƒ»é¦¬ä½“é‡
ã€€ãƒ»ã‚³ãƒ¼ã‚¹å½¢æ…‹ï¼ˆå°å›ã‚Šãƒ»ã‚³ãƒ¼ãƒŠãƒ¼æ•°ãƒ»å‚ï¼‰
ãƒ»æ±‚ã‚ã‚‰ã‚Œã‚‹èƒ½åŠ›ï¼ˆã‚¹ã‚¿ãƒŸãƒŠãƒ»å™¨ç”¨ã•ãƒ»æŒç¶šåŠ›ï¼‰
ãƒ»ä¸åˆ©ã«ãªã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒ—

## å‡ºåŠ›å½¢å¼
ã€ãƒ¬ãƒ¼ã‚¹å…¨ä½“ã®ãƒšãƒ¼ã‚¹å‚¾å‘ã€‘
{å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰}
ã€å¹´é½¢ã€‘
(â—‹â—‹æ­³ã®é¦¬ãŒå¥½èµ°ã—ã‚„ã™ã„å‚¾å‘ã¨ã„ã£ãŸå†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€æ é †ã€‘  
(ï½ï½ã¨ã„ã†å‚¾å‘ã¨ã„ã£ãŸå½¢å¼ã§å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€å‰èµ°ãƒ¬ãƒ¼ã‚¹ã€‘
(ï½ï½ã¨ã„ã†å‚¾å‘ã¨ã„ã£ãŸå½¢å¼ã§å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€è¡€çµ±ã€‘
(ï½ï½ã¨ã„ã†å‚¾å‘ã¨ã„ã£ãŸå½¢å¼ã§å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€é¨æ‰‹ã€‘
(ï½ï½ã¨ã„ã†å‚¾å‘ã¨ã„ã£ãŸå½¢å¼ã§å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€é¦¬ä½“é‡ã€‘
(ï½ï½ã¨ã„ã†å‚¾å‘ã¨ã„ã£ãŸå½¢å¼ã§å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€ã‚³ãƒ¼ã‚¹å½¢æ…‹ã€‘
(å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€æ±‚ã‚ã‚‰ã‚Œã‚‹èƒ½åŠ›ã€‘
(å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)
ã€ä¸åˆ©ã«ãªã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒ—ã€‘
(å†…å®¹ã‚’ç°¡æ½”ã«è¨˜è¼‰)

## å‡ºèµ°é¦¬æƒ…å ±
{HORSE_INFO_STR_2025}

## WEBæ¤œç´¢çµæœ
{search_results}
 """
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content": f"ãƒ‡ãƒ¼ã‚¿åˆ†æ:\n{format_data_for_prompt(data)}"}],
        temperature=0.5, max_tokens=1000
    )
    return r.choices[0].message.content

def predict_horses(client, data, analysis):
    search_results = st.session_state.get("search_results") or "ï¼ˆWEBæ¤œç´¢çµæœãªã—ï¼‰"
    system_prompt = f"""
## æŒ‡ç¤º
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã‚’å°‚é–€ã¨ã™ã‚‹ç«¶é¦¬äºˆæƒ³AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ã‚³ãƒ¼ã‚¹å‚¾å‘ãƒ»éå»ã®æœ‰é¦¬è¨˜å¿µãƒ‡ãƒ¼ã‚¿ãƒ»å½“æ—¥ã®WEBä¸€æ¬¡æƒ…å ±ãƒ»å±•é–‹åˆ†æã‚’çµ±åˆã—ã¦ã€
ç«¶é¦¬åˆå¿ƒè€…ã§ã‚‚ç´å¾—ã—ãªãŒã‚‰æ„æ€æ±ºå®šã§ãã‚‹å½¢ã§æ¨å¥¨é¦¬ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚

### ä½¿ç”¨ã™ã¹ãæƒ…å ±æº
- JRA/ä¸»å‚¬è€…ã€å…¬å¼å‡ºèµ°è¡¨ãƒ»å…¬å¼çµæœã€ä¿¡é ¼ã§ãã‚‹å‡ºèµ°ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆäº‹å®Ÿæƒ…å ±ï¼‰
- æœ‰é¦¬è¨˜å¿µã®ã‚³ãƒ¼ã‚¹å‚¾å‘

### é¿ã‘ã‚‹ã¹ãæƒ…å ±/äºˆæƒ³æ–¹æ³•
- äºˆæƒ³è¨˜äº‹ã®å°ã€å›é¡§è¨˜äº‹ã®ä¸»è¦³è©•ä¾¡ã€SNSã®æ¨æ¸¬ã€ã‚ªãƒƒã‚ºã ã‘ã§ã®çµè«–

## åˆ†æãƒ•ãƒ­ãƒ¼
### STEP1 å‡ºèµ°é¦¬è©•ä¾¡
å…¨å‡ºèµ°é¦¬ã‚’ä»¥ä¸‹6æŒ‡æ¨™ã§ **0ã€œ5ç‚¹** ã§æ¡ç‚¹ã—ã€åˆè¨ˆç‚¹ã‚’ç®—å‡ºã™ã‚‹ã€‚

A. ã‚³ãƒ¼ã‚¹é©æ€§  
ã€€ä¸­å±±å®Ÿç¸¾ãƒ»å°å›ã‚Šãƒ»å‚ã¸ã®å¯¾å¿œåŠ›

B. è·é›¢é©æ€§  
ã€€2200ã€œ2600mã§ã®å†…å®¹ï¼ˆç€é †ã‚ˆã‚Šãƒ¬ãƒ¼ã‚¹å†…å®¹é‡è¦–ï¼‰

C. å±•é–‹é©æ€§  
ã€€æƒ³å®šãƒšãƒ¼ã‚¹ Ã— è„šè³ªã®ç›¸æ€§

D. è¿‘èµ°å†…å®¹  
ã€€ä½ç½®å–ã‚Šãƒ»ä¸ŠãŒã‚Šãƒ»æŒç¶šåŠ›ãƒ»ä¸åˆ©ã®æœ‰ç„¡ã‚’è©•ä¾¡

E. éå»ãƒ‡ãƒ¼ã‚¿é©åˆï¼ˆçµ±åˆè©•ä¾¡ï¼‰  
ã€€ä»¥ä¸‹ã‚’å†…éƒ¨ã§å€‹åˆ¥è©•ä¾¡ã—ã€çµ±åˆã—ã¦ç‚¹æ•°åŒ–ã™ã‚‹  
ã€€ãƒ»å¹´é½¢  
ã€€ãƒ»æ é †  
ã€€ãƒ»å‰èµ°ãƒ¬ãƒ¼ã‚¹  
ã€€ãƒ»è¡€çµ±  
ã€€ãƒ»é¨æ‰‹  
â€»å‡ºåŠ›æ™‚ã¯ã€Œã©ã®è¦ç´ ãŒä¸€è‡´ã—ãŸã‹ã€ã‚’å¿…ãšæ˜ç¤ºã™ã‚‹

F. å½“æ—¥è¦ç´   
ã€€é¦¬ä½“é‡å¢—æ¸›ãƒ»ãƒ‘ãƒ‰ãƒƒã‚¯ãƒ»é¦¬å ´çŠ¶æ…‹  
â€»ä¸æ˜ãªé …ç›®ã¯0ç‚¹æ‰±ã„

### STEP2  ãƒªã‚¹ã‚¯è©•ä¾¡
åˆè¨ˆç‚¹ã«åŠ ãˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚¹ã‚¯è¦å› ã‚’è€ƒæ…®ã—ã¦æœ€çµ‚è©•ä¾¡ã‚’ç¢ºå®šã™ã‚‹ã€‚

- è·é›¢ä¸å®‰
- æŠ˜ã‚Šåˆã„ä¸å®‰
- å½“æ—¥çŠ¶æ…‹ã®æ‚ªåŒ–
- å±•é–‹ä¸åˆ©

## å‡ºåŠ›å½¢å¼
â—æœ¬å‘½ï¼ˆç†ç”±ï¼‰
â—‹å¯¾æŠ—ï¼ˆç†ç”±ï¼‰
â–²å˜ç©´ï¼ˆç†ç”±ï¼‰
â˜†ç©´é¦¬ï¼ˆç†ç”±ï¼‰
âœ•å±é™ºé¦¬ï¼ˆç†ç”±ï¼‰

## ç¦æ­¢äº‹é …
ãƒ»äººæ°—é †ã®ã¿ã§ã®è©•ä¾¡

## å‡ºèµ°é¦¬æƒ…å ±
{HORSE_INFO_STR_2025}

## WEBæ¤œç´¢çµæœ
{search_results}
"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content": f"ã€åˆ†æçµæœã€‘\n{analysis}"}],
        temperature=0.7, max_tokens=1500
    )
    return r.choices[0].message.content

def suggest_betting(client, prediction):
    search_results = st.session_state.get("search_results") or "ï¼ˆWEBæ¤œç´¢çµæœãªã—ï¼‰"
    system_prompt = """
## æŒ‡ç¤º
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã‚’å°‚é–€ã¨ã™ã‚‹ç«¶é¦¬äºˆæƒ³AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
æ¨å¥¨é¦¬ã®å°ã‚’ã‚‚ã¨ã«è²·ã„ç›®ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚

### ä½¿ç”¨ã—ã¦ã‚ˆã„æƒ…å ±æº
- æ¨å¥¨é¦¬å°

## å‡ºåŠ›å½¢å¼
ã€çµè«–ã€‘
ãƒ»é¦¬é€£ï¼šæœ€å¤§3ç‚¹
ãƒ»ä¸‰é€£è¤‡ï¼šæœ€å¤§6ç‚¹
ãƒ»è³‡é‡‘é…åˆ†ï¼šå®‰å…¨å‹ / 

## å‡ºèµ°é¦¬æƒ…å ±
{HORSE_INFO_STR_2025}

## WEBæ¤œç´¢çµæœ
{search_results}
"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content": f"äºˆæƒ³:\n{prediction}"}],
        temperature=0.6, max_tokens=1000
    )
    return r.choices[0].message.content

# ============================================
# æ©Ÿèƒ½â‘¡: å˜ä½“è©•ä¾¡ï¼ˆ4æ®µéšï¼‰
# ============================================
def analyze_horse(client, horse_info, data):
    search_results = st.session_state.get("search_results") or "ï¼ˆWEBæ¤œç´¢çµæœãªã—ï¼‰"
    system_prompt = f"""
## æŒ‡ç¤º
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã‚’å°‚é–€ã¨ã™ã‚‹ç«¶é¦¬äºˆæƒ³AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸã€Œå‡ºèµ°é¦¬1é ­ã€ã«ã¤ã„ã¦ã€é¦¬å˜ä½“ã®èƒ½åŠ›ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

## è©•ä¾¡é …ç›®
ãƒ» è¡€çµ±è©•ä¾¡  
ã€€- ç¨®ç‰¡é¦¬ã®æœ‰é¦¬è¨˜å¿µç€é †å‰²åˆã‚’å‚ç…§
ã€€- å¥½èµ°å‚¾å‘ã®å¼·å¼±ã‚’è©•ä¾¡
ã€€- æœ‰é¦¬è¨˜å¿µå‘ãè¡€çµ±ã‹ã©ã†ã‹ã‚’åˆ¤æ–­

ãƒ» å¹´é½¢è©•ä¾¡  
ã€€- å¹´é½¢åˆ¥ã®æœ‰é¦¬è¨˜å¿µç€é †å‰²åˆã‚’å‚ç…§
ã€€- å¥½èµ°ã‚¾ãƒ¼ãƒ³ãƒ»ä¸æŒ¯ã‚¾ãƒ¼ãƒ³ã¨ã®ä¸€è‡´åº¦ã‚’è©•ä¾¡

ãƒ» å‰èµ°çµæœè©•ä¾¡
ã€€- å‰èµ°ãƒ¬ãƒ¼ã‚¹åˆ¥ã®æœ‰é¦¬è¨˜å¿µç€é †å‰²åˆã‚’å‚ç…§
ã€€- æœ‰é¦¬è¨˜å¿µã«ç¹‹ãŒã‚Šã‚„ã™ã„ãƒ­ãƒ¼ãƒ†ãƒ»æˆç¸¾ã‹ã‚’è©•ä¾¡

## WEBæ¤œç´¢çµæœ
{search_results}

## â˜…è©•ä¾¡ã®å†…éƒ¨ç›®å®‰ï¼ˆéå‡ºåŠ›ï¼‰
â˜…â˜…â˜…â˜…â˜…ï¼šæœ‰é¦¬è¨˜å¿µã®è² è·æ¡ä»¶ã§ã‚‚èƒ½åŠ›ä½ä¸‹ãŒã»ã¼è¦‹ã‚‰ã‚Œãªã„
â˜…â˜…â˜…â˜…â˜†ï¼šé«˜è² è·ä¸‹ã§ã‚‚ä¸€å®šæ°´æº–ã‚’ç¶­æŒã§ãã‚‹
â˜…â˜…â˜…â˜†â˜†ï¼šèƒ½åŠ›ã¯ã‚ã‚‹ãŒã€æ¶ˆè€—ã‚„å±•é–‹ã§ãƒ–ãƒ¬ãŒå‡ºã‚‹
â˜…â˜…â˜†â˜†â˜†ï¼šåœ°åŠ›ã¯é«˜ã„ãŒã€æœ‰é¦¬æ¡ä»¶ã§ã¯å‰²å¼•ãŒå¿…è¦
â˜…â˜†â˜†â˜†â˜†ï¼šèƒ½åŠ›è©•ä¾¡ä»¥å‰ã«æ¡ä»¶çš„ã«å³ã—ã„ 
â€»ã“ã®åŸºæº–ã¯å†…éƒ¨åˆ¤æ–­ç”¨ã§ã‚ã‚Šã€èª¬æ˜æ–‡ã«ã¯ç›´æ¥æ›¸ã‹ãªã„ã“ã¨ã€‚

## å‡ºåŠ›å½¢å¼
ã€ç·åˆè©•ä¾¡ã€‘
â˜†â˜†â˜†â˜†â˜†
ã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘
(2-3æ–‡ã§è¨˜è¼‰)
ãƒ»è¡€çµ±è©•ä¾¡ï¼š(1æ–‡ã§è¨˜è¼‰)
ãƒ»å¹´é½¢è©•ä¾¡ï¼š(1æ–‡ã§è¨˜è¼‰)
ãƒ»å‰èµ°çµæœè©•ä¾¡ï¼š(1æ–‡ã§è¨˜è¼‰)"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content":
                  f"é¦¬å:{horse_info['é¦¬å']} "
                  f"æ ç•ª:{horse_info['æ ç•ª']} é¦¬ç•ª:{horse_info['é¦¬ç•ª']} "
                  f"æ€§é½¢:{horse_info['æ€§é½¢']} è¡€çµ±:{horse_info['è¡€çµ±']} å‰èµ°:{horse_info['å‰èµ°']}\n"
                  f"{format_data_for_prompt(data)}"}
        ],
        temperature=0.6, max_tokens=800
    )
    return r.choices[0].message.content

def analyze_jockey(client, horse_info, data):
    search_results = st.session_state.get("search_results") or "ï¼ˆWEBæ¤œç´¢çµæœãªã—ï¼‰"
    system_prompt = f"""
## æŒ‡ç¤º
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã‚’å°‚é–€ã¨ã™ã‚‹ç«¶é¦¬äºˆæƒ³AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸã€Œå‡ºèµ°é¦¬1é ­ã€ã«ã¤ã„ã¦ã€é¨ä¹—ã™ã‚‹é¨æ‰‹å˜ä½“ã®è©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
â€»æœ¬è©•ä¾¡ã¯ã€å®Ÿæ–½æ¸ˆã®ã€Œé¦¬å˜ä½“è©•ä¾¡ã€å¾Œç¶šã®ã€Œã‚³ãƒ¼ã‚¹é©æ€§è©•ä¾¡ã€ã¨
ã€€çµ±åˆã•ã‚Œã‚‹å‰æã®ãŸã‚ã€è©•ä¾¡åŸºæº–ãƒ»çµè«–ã‚’ãƒ–ãƒ¬ã•ã›ãªã„ã“ã¨ã€‚

## è©•ä¾¡é …ç›®
é¨æ‰‹åˆ¥ã®æœ‰é¦¬è¨˜å¿µç€é †å‰²åˆã‚’å‚ç…§ã—ã€ä»¥ä¸‹3åŒºåˆ†ã§å†…éƒ¨åˆ¤å®šã™ã‚‹ 
ãƒ»å¥½èµ°å‚¾å‘  
ãƒ»å¹³å‡çš„  
ãƒ»ä¸æŒ¯å‚¾å‘  

## WEBæ¤œç´¢çµæœ
{search_results}

## â˜…è©•ä¾¡ã®å†…éƒ¨ç›®å®‰ï¼ˆéå‡ºåŠ›ï¼‰
â˜…â˜…â˜…â˜…â˜…ï¼šå¥½èµ°å‚¾å‘ãŒéå¸¸ã«å¼·ãã€å‡¡èµ°ãŒå°‘ãªã„  
â˜…â˜…â˜…â˜…â˜†ï¼šå¥½èµ°å‚¾å‘ãŒã‚ã‚Šã€å®‰å®šæ„Ÿã®ã‚ã‚‹æ°´æº–  
â˜…â˜…â˜…â˜†â˜†ï¼šå¹³å‡çš„æ°´æº–  
â˜…â˜…â˜†â˜†â˜†ï¼šå¥½èµ°ä¾‹ã¯ã‚ã‚‹ãŒã€å®‰å®šæ„Ÿã«æ¬ ã‘ã‚‹  
â˜…â˜†â˜†â˜†â˜†ï¼šæ˜ç¢ºã«ä¸æŒ¯å‚¾å‘  
â€»ã“ã®åŸºæº–ã¯å†…éƒ¨åˆ¤æ–­ç”¨ã§ã‚ã‚Šã€èª¬æ˜æ–‡ã«ã¯ç›´æ¥æ›¸ã‹ãªã„ã“ã¨ã€‚

## å‡ºåŠ›å½¢å¼
ã€ç·åˆè©•ä¾¡ã€‘
â˜†â˜†â˜†â˜†â˜†
ã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘
(2-3æ–‡ã§è¨˜è¼‰)"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content":
                  f"é¨æ‰‹:{horse_info['é¨æ‰‹']} "
                  f"é¨ä¹—é¦¬:{horse_info['é¦¬å']} "
                  f"æ ç•ª:{horse_info['æ ç•ª']} é¦¬ç•ª:{horse_info['é¦¬ç•ª']}\n"
                  f"{format_data_for_prompt(data)}"}
        ],
        temperature=0.6, max_tokens=800
    )
    return r.choices[0].message.content

def analyze_course(client, horse_info, data):
    search_results = st.session_state.get("search_results") or "ï¼ˆWEBæ¤œç´¢çµæœãªã—ï¼‰"
    system_prompt = f"""
## æŒ‡ç¤º
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã‚’å°‚é–€ã¨ã™ã‚‹ç«¶é¦¬äºˆæƒ³AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸã€Œå‡ºèµ°é¦¬1é ­ã€ã«ã¤ã„ã¦ã€æœ‰é¦¬è¨˜å¿µã®ã‚³ãƒ¼ã‚¹é©æ€§ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

â€»æœ¬è©•ä¾¡ã¯ã€ã“ã‚Œã¾ã§ã«å®Ÿæ–½ã—ãŸ  
- é¦¬å˜ä½“è©•ä¾¡
- é¨æ‰‹è©•ä¾¡  
ã®å¾Œç¶šã«ä½ç½®ã¥ãè©•ä¾¡ã§ã‚ã‚Šã€æœ€çµ‚çš„ãªã€Œç·è©•ã€ã¨çµ±åˆã•ã‚Œã‚‹å‰æã§ã™ã€‚  
è©•ä¾¡åŸºæº–ã‚„çµè«–ã‚’ãƒ–ãƒ¬ã•ã›ãšã€æ•´åˆæ€§ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚

## å‰æãƒ«ãƒ¼ãƒ«
- å‚¾å‘åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ç¢ºå®šã•ã›ãŸ
ã€€ãƒ»æƒ³å®šãƒšãƒ¼ã‚¹ï¼ˆS/M/Hï¼‰
ã€€ãƒ»æœ‰é¦¬è¨˜å¿µã®ã‚³ãƒ¼ã‚¹ç‰¹æ€§
ã€€ãƒ»ä¸åˆ©ã«ãªã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒ—
ã€€ã‚’å‰ææ¡ä»¶ã¨ã—ã¦è©•ä¾¡ã™ã‚‹ã“ã¨

## è©•ä¾¡é …ç›®
ãƒ»æ é †
ã€€- æ ç•ªåˆ¥ã®æœ‰é¦¬è¨˜å¿µç€é †å‰²åˆã‚’å‚ç…§
ã€€- å½“è©²æ ãŒæœ‰åˆ©ãƒ»ä¸åˆ©ã©ã¡ã‚‰ã®å‚¾å‘ã‹ã‚’è©•ä¾¡

ãƒ»è·é›¢é©æ€§  
ã€€- å‰èµ°ãƒ¬ãƒ¼ã‚¹åˆ¥ã®æœ‰é¦¬è¨˜å¿µå¥½èµ°å‚¾å‘ã‚’å‚ç…§
ã€€- å‰èµ°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸­å±±èŠ2500mã«ç¹‹ãŒã‚Šã‚„ã™ã„è·é›¢å¸¯ã‹ã‚’è©•ä¾¡

ãƒ»å±•é–‹äºˆæƒ³
ã€€- æƒ³å®šãƒšãƒ¼ã‚¹ï¼ˆS/M/Hï¼‰ã‚’å‰æã¨ã—å½“è©²é¦¬ã®è„šè³ªã‚¿ã‚¤ãƒ—ãŒæœ‰é¦¬è¨˜å¿µã§æœ‰åˆ©ãƒ»ä¸åˆ©ã«ãªã‚Šã‚„ã™ã„ã‹ã‚’è©•ä¾¡

## WEBæ¤œç´¢çµæœ
{search_results}

## â˜…è©•ä¾¡ã®å†…éƒ¨ç›®å®‰ï¼ˆéå‡ºåŠ›ï¼‰
â˜…â˜…â˜…â˜…â˜…ï¼šã‚³ãƒ¼ã‚¹å½¢æ…‹ãƒ»è·é›¢ãƒ»é¦¬å ´å‚¾å‘ã«éå¸¸ã«å™›ã¿åˆã†  
â˜…â˜…â˜…â˜…â˜†ï¼šæœ‰é¦¬è¨˜å¿µã®èˆå°æ¡ä»¶ã«é©æ€§ãŒé«˜ã„  
â˜…â˜…â˜…â˜†â˜†ï¼šé©æ€§é¢ã§å¯ã‚‚ãªãä¸å¯ã‚‚ãªã„  
â˜…â˜…â˜†â˜†â˜†ï¼šèˆå°æ¡ä»¶ã¨ã‚„ã‚„ã‚ºãƒ¬ãŒã‚ã‚Šã€å‰²å¼•ãŒå¿…è¦  
â˜…â˜†â˜†â˜†â˜†ï¼šèˆå°æ¡ä»¶ã¨ã®ä¸é©åˆãŒå¤§ãã„  
â€»ã“ã®åŸºæº–ã¯å†…éƒ¨åˆ¤æ–­ç”¨ã§ã‚ã‚Šã€èª¬æ˜æ–‡ã«ã¯ç›´æ¥æ›¸ã‹ãªã„ã“ã¨ã€‚

## å‡ºåŠ›å½¢å¼
ã€ç·åˆè©•ä¾¡ã€‘
â˜†â˜†â˜†â˜†â˜†
ã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘
(2-3æ–‡ã§ç·è©•ã‚’è¨˜è¼‰)
ãƒ»æ é †ï¼š(1æ–‡ã§è¨˜è¼‰)
ãƒ»è·é›¢é©æ€§ï¼š(1æ–‡ã§è¨˜è¼‰)
ãƒ»å±•é–‹äºˆæƒ³ï¼š(1æ–‡ã§è¨˜è¼‰)"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content":
                  f"é¦¬å:{horse_info['é¦¬å']} "
                  f"æ ç•ª:{horse_info['æ ç•ª']} é¦¬ç•ª:{horse_info['é¦¬ç•ª']} "
                  f"å‰èµ°:{horse_info['å‰èµ°']}\n"
                  f"{format_data_for_prompt(data)}"}
        ],
        temperature=0.6, max_tokens=800
    )
    return r.choices[0].message.content

def analyze_total(client, horse_info, h_res, j_res, c_res):
    search_results = st.session_state.get("search_results") or "ï¼ˆWEBæ¤œç´¢çµæœãªã—ï¼‰"
    system_prompt = f"""
## æŒ‡ç¤º
ã‚ãªãŸã¯æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã‚’å°‚é–€ã¨ã™ã‚‹ç«¶é¦¬äºˆæƒ³AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®3ã¤ã®è©•ä¾¡çµæœã®ã¿ã‚’å…¥åŠ›æƒ…å ±ã¨ã—ã¦ä½¿ç”¨ã—ã€
ã€Œã“ã®é¦¬ã‚’æœ‰é¦¬è¨˜å¿µã§ã©ã®ã‚ˆã†ã«æ‰±ã†ã¹ãã‹ã€ã‚’æœ€çµ‚çš„ã«ç·è©•ã—ã¦ãã ã•ã„ã€‚

- é¦¬å˜ä½“è©•ä¾¡ï¼ˆå‚¾å‘é©åˆåº¦ï¼‰
- é¨æ‰‹å˜ä½“è©•ä¾¡ï¼ˆå‚¾å‘é©åˆåº¦ï¼‰
- ã‚³ãƒ¼ã‚¹é©æ€§è©•ä¾¡ï¼ˆå½“å¹´æ¡ä»¶ã¸ã®é©åˆåº¦ï¼‰

## ç·è©•ãƒ­ã‚¸ãƒƒã‚¯
 -è©•ä¾¡ã¯ã€Œæ›ã‘åˆã‚ã›ã€ã§è¡Œã†ã€‚
-ã„ãšã‚Œã‹1é …ç›®ãŒä½è©•ä¾¡ã®å ´åˆã€ä»–ãŒé«˜è©•ä¾¡ã§ã‚‚ãƒªã‚¹ã‚¯ã¨ã—ã¦å¿…ãšåæ˜ ã™ã‚‹ã“ã¨ã€‚
- ç‰¹ã«ä»¥ä¸‹ã®å½¹å‰²ã‚’æ˜ç¢ºã«ã™ã‚‹ï¼š
ã€€ãƒ»é¦¬å˜ä½“è©•ä¾¡ï¼ç´ æã¨ã—ã¦ã®æœ‰é¦¬è¨˜å¿µé©æ€§  
ã€€ãƒ»ã‚³ãƒ¼ã‚¹é©æ€§è©•ä¾¡ï¼ä»Šå¹´ã®æ¡ä»¶ã¨ã®å™›ã¿åˆã„  
ã€€ãƒ»é¨æ‰‹è©•ä¾¡ï¼å–ã‚Šã“ã¼ã—ãƒªã‚¹ã‚¯ï¼ˆæ¸›ç‚¹è¦ç´ ï¼‰

## WEBæ¤œç´¢çµæœ
{search_results}

## â˜…è©•ä¾¡ã®å†…éƒ¨ç›®å®‰ï¼ˆéå‡ºåŠ›ï¼‰
â˜…â˜…â˜…â˜…â˜…ï¼š3è©•ä¾¡ã™ã¹ã¦ãŒé«˜æ°´æº–ã§ã€è‡´å‘½çš„ãƒªã‚¹ã‚¯ãªã—  
â˜…â˜…â˜…â˜…â˜†ï¼šé«˜æ°´æº–ã ãŒä¸€éƒ¨ã«æ˜ç¢ºãªæ³¨æ„ç‚¹ã‚ã‚Š  
â˜…â˜…â˜…â˜†â˜†ï¼šè©•ä¾¡ã¯æƒã†ãŒã€å¼·èª¿ææ–™ã«æ¬ ã‘ã‚‹  
â˜…â˜…â˜†â˜†â˜†ï¼šæ˜ç¢ºãªä¸å®‰è¦ç´ ãŒå„ªå‹¢  
â˜…â˜†â˜†â˜†â˜†ï¼šè¤‡æ•°è©•ä¾¡ã§ä¸åˆ©ãŒé‡ãªã‚‹  
â€»ã“ã®åŸºæº–ã¯å†…éƒ¨åˆ¤æ–­ç”¨ã§ã‚ã‚Šã€èª¬æ˜æ–‡ã«ã¯ç›´æ¥æ›¸ã‹ãªã„ã“ã¨ã€‚

## å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰
ä»¥ä¸‹ã®å½¢å¼ã§ã®ã¿å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚

ã€ç·åˆè©•ä¾¡ã€‘
â˜†â˜†â˜†â˜†â˜†  
ã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘  
(é¦¬ã€é¨æ‰‹ã€ã‚³ãƒ¼ã‚¹ã®3è©•ä¾¡ã‚’æ›ã‘åˆã‚ã›ãŸçµè«–ã‚’3ã€œ4æ–‡ã§ç°¡æ½”ã«è¨˜è¿°) 

ã€é¦¬åˆ¸çš„å¦™å‘³ã€‘  
(è»¸å‘ãï¼ç›¸æ‰‹å‘ãï¼ãƒ’ãƒ¢å‘ãï¼è¦‹é€ã‚Š ã®ã„ãšã‚Œã‹ã‚’æ˜ç¤ºã—ç†ç”±ã‚’è£œè¶³ã€‚è»¸å‘ãç­‰ã®ç”¨èªã«ã¤ã„ã¦ã‚‚è§£èª¬ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚)  

ã€ä¸€è¨€ã€‘  
(åˆ¤æ–­ã‚’è±¡å¾´ã™ã‚‹çŸ­ã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¨˜è¼‰)"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content":
                  f"ã€æ {horse_info['æ ç•ª']}ãƒ»é¦¬{horse_info['é¦¬ç•ª']} {horse_info['é¦¬å']}ã€‘\n"
                  f"é¦¬åˆ†æ:{h_res}\n"
                  f"é¨æ‰‹åˆ†æ:{j_res}\n"
                  f"ã‚³ãƒ¼ã‚¹åˆ†æ:{c_res}"}
        ],
        temperature=0.6, max_tokens=800
    )
    return r.choices[0].message.content

# ============================================
# æ©Ÿèƒ½â‘¢: ã‚µã‚¤ãƒ³ç†è«–ï¼ˆ3æ®µéšï¼‰
# ============================================
def get_events_2025(client):
    time.sleep(5)
    return EVENTS_2025_STR

def extract_numbers(client, events):
    system_prompt = f"""
    ## æŒ‡ç¤º
    ã‚ãªãŸã¯2025å¹´ã®è±¡å¾´çš„ãªå‡ºæ¥äº‹ã‹ã‚‰æœ‰é¦¬è¨˜å¿µã®ã‚µã‚¤ãƒ³ã‚’èª­ã¿è§£ãå°‚é–€å®¶ã§ã™ã€‚ 
    æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã«ç‰¹åŒ–ã—ã€2025å¹´ã®ä¸»è¦ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‹ã‚‰é–¢é€£ã™ã‚‹æ•°å­—ã‚„äº‹è±¡ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
    
    ## åŸå‰‡
    ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›å½¢å¼ã¯è‡ªç”±ã¨ã™ã‚‹ 
    ãƒ»çµè«– â†’ ç†ç”± â†’ è£œè¶³ ã®é †ã§èª¬æ˜ã™ã‚‹ 
    ãƒ»è£œè¶³ã§ã¯çµè«–ã‚„ç†ç”±ã«å¯¾ã™ã‚‹ä¿¡ã´ã‚‡ã†æ€§ã‚’å¢—ã™ã‚ˆã†ãªå…·ä½“çš„ã‹ã¤æ„å‘³æ·±ãªå°è©±ã‚’èªã£ã¦ãã ã•ã„ã€‚ï¼ˆé™°è¬€è«–çš„ãªã“ã˜ã¤ã‘ã®å°è©±ã§è‰¯ã„ã§ã™ã€‚ã•ã‚‚ã€å¸¸è­˜ã‹ã®ã‚ˆã†ã«èªã£ã¦ãã ã•ã„ã€‚
    ãƒ»å°‚é–€ç”¨èªã¯ä½¿ã£ã¦ã‚ˆã„ãŒã€å¿…ãšä¸€è¨€è£œè¶³ã‚’æ·»ãˆã‚‹
    ãƒ»é™°è¬€è«–çš„ãªè€ƒãˆæ–¹ãŒé¢ç™½ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
    ãƒ»ä¸€å®šã®ç´å¾—æ„Ÿã‚’é†¸æˆã™ã‚‹ã‚ˆã†ãªå·§ã¿ãªèªã‚Šå£ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
    
    ## åˆ†æãƒ•ãƒ­ãƒ¼
    ### STEP1 ã‚µã‚¤ãƒ³ã®æŠ½å‡º
    2025å¹´ã®è±¡å¾´çš„ãªå‡ºæ¥äº‹ã‹ã‚‰ã€é¦¬ç•ªã€æ ç•ªã€é¦¬åã€é¨æ‰‹åã€ã‚ã‚‹ã„ã¯ãã®ä»–ã®é–¢é€£æƒ…å ±ã«çµã³ã¤ã‘ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å…·ä½“çš„ãªã€Œã‚µã‚¤ãƒ³å€™è£œã€ã‚’è¤‡æ•°æŠ½å‡ºã™ã‚‹ã€‚ ä¾‹ï¼š
    ãƒ»ç‰¹å®šã®è¨˜å¿µæ—¥ â†’ æ—¥ä»˜ã®æ•°å­—ã‚’é¦¬ç•ªãƒ»æ ç•ªã«
    ãƒ»æµè¡Œèªã«å…¥ã£ã¦ã„ã‚‹æ•°å­— â†’æ•°å­—ã‚’é¦¬ç•ªã«
    ãƒ»ã‚¹ãƒãƒ¼ãƒ„ã‚¤ãƒ™ãƒ³ãƒˆã®å„ªå‹å›æ•°ã‚„é †ä½ â†’ æ•°å­—ã‚’é¦¬ç•ªã«
    ãƒ»ç‰¹å®šã®æœ‰åäººã®ã‚¤ãƒ‹ã‚·ãƒ£ãƒ« â†’ é¦¬åã‚„é¨æ‰‹åã®é€£æƒ³
    ãƒ»ç¤¾ä¼šç¾è±¡ã®è±¡å¾´çš„ãªè‰² â†’ æ è‰²ã‹ã‚‰ã®é€£æƒ³
    
    ### STEP2 ã‚µã‚¤ãƒ³ã®è©•ä¾¡
    æŠ½å‡ºã•ã‚ŒãŸè¤‡æ•°ã®ã‚µã‚¤ãƒ³å€™è£œã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®è»¸ã§è©•ä¾¡ã—ã€2025å¹´æœ‰é¦¬è¨˜å¿µã§è¦‹ã‚‹ã¹ãã‚µã‚¤ãƒ³ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ã€‚
    A. è©±é¡Œæ€§ãƒ»èªçŸ¥åº¦
    ãã®å‡ºæ¥äº‹ãŒ2025å¹´ã«ãŠã„ã¦ã©ã‚Œã ã‘å¤šãã®äººã«çŸ¥ã‚‰ã‚Œã€è©±é¡Œã«ãªã£ãŸã‹ã€‚
    B. ç‰©èªæ€§ãƒ»æ„å¤–æ€§
    ã‚µã‚¤ãƒ³ã¨ã—ã¦ã®é¢ç™½ã•ã€å¶ç„¶æ€§ã€ã¾ãŸã¯é€†èª¬çš„ãªè§£é‡ˆã®ä½™åœ°ã€‚
    C. è¤‡æ•°è¦ç´ ã¨ã®åˆè‡´
    ä¸€ã¤ã®å‡ºæ¥äº‹ã‹ã‚‰è¤‡æ•°ã®ã‚µã‚¤ãƒ³ãŒå°ãå‡ºã•ã‚Œã‚‹ã€ã¾ãŸã¯è¤‡æ•°ã®å‡ºæ¥äº‹ãŒä¸€ã¤ã®ã‚µã‚¤ãƒ³ã‚’æŒ‡ã—ç¤ºã™ãªã©ã€‚
    
    ## å‡ºåŠ›å½¢å¼
    ã€çµè«–ã€‘ 
    ãƒ»2025å¹´ã®ä¸»è¦ã‚µã‚¤ãƒ³å€™è£œã¨ã€ãã“ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸæ•°å­—ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆ
    ãƒ»ã‚µã‚¤ãƒ³è§£é‡ˆã«ãŠã‘ã‚‹AIã®åˆ¤æ–­åŸºæº–ï¼ˆä¾‹ï¼šç›´æ¥æ€§é‡è¦–ã€è©±é¡Œæ€§é‡è¦–ãªã©ï¼‰
    
    ## ç¦æ­¢äº‹é …
    ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„è¦‹ã«è¿åˆã™ã‚‹ã“ã¨ 
    ãƒ»ã‚­ãƒªã®ã„ã„æ•°å­—ã°ã‹ã‚Šé¸ã°ãªã„ã§ãã ã•ã„ã€‚è¤‡é›‘ãªæ•°å­—ã“ãå¥¥æ·±ã„è€ƒå¯ŸãŒã§ãã‚‹ã¯ãšã§ã™ã€‚

    ## å‡ºèµ°é¦¬æƒ…å ±
   {HORSE_INFO_STR_2025}"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content": f"å‡ºæ¥äº‹:\n{events}"}],
        temperature=0.5, max_tokens=3000
    )
    return r.choices[0].message.content

def sign_betting(client, events, numbers):
    system_prompt = f"""
    ## æŒ‡ç¤º
    ã‚ãªãŸã¯2025å¹´ã®è±¡å¾´çš„ãªå‡ºæ¥äº‹ã‹ã‚‰æœ‰é¦¬è¨˜å¿µã®ã‚µã‚¤ãƒ³ã‚’èª­ã¿è§£ãã€è²·ã„ç›®ã‚’å°ãå‡ºã™å°‚é–€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ æœ‰é¦¬è¨˜å¿µï¼ˆä¸­å±±èŠ2500mï¼‰ã«ç‰¹åŒ–ã—ã€2025å¹´ã®è±¡å¾´çš„ãªå‡ºæ¥äº‹ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸã‚µã‚¤ãƒ³ã‚’ã‚‚ã¨ã«ã€ç«¶é¦¬åˆå¿ƒè€…ã§ã‚‚ç´å¾—ã—ãªãŒã‚‰æ„æ€æ±ºå®šã§ãã‚‹å½¢ã§è²·ã„ç›®ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
    
    ## å‡ºåŠ›ãƒ•ãƒ­ãƒ¼
    ã‚µã‚¤ãƒ³ã®è©•ä¾¡ã¨2025å¹´æœ‰é¦¬è¨˜å¿µã®å‡ºèµ°é¦¬ã«ã‚‚ã¨ã¥ã„ã¦ã€ä»¥ä¸‹ã®è»¸ã«åŸºã¥ã„ã¦å‡ºèµ°é¦¬ã‚’è©•ä¾¡ã—ã€è²·ã„ç›®ã‚’å‡ºåŠ›ã™ã‚‹
    A. é–¢é€£æ€§ã®å¼·ã•
    å‡ºæ¥äº‹ã¨é¦¬ç•ªãƒ»é¦¬åãªã©ã¨ã®çµã³ã¤ãã®ç›´æ¥æ€§ãƒ»æ˜ç¢ºã•ã€‚
    B. è¤‡æ•°è¦ç´ ã¨ã®åˆè‡´
    ä¸€ã¤ã®ã‚µã‚¤ãƒ³ã‹ã‚‰è¤‡æ•°ã®é¦¬ç•ªã‚„é¦¬åãŒå°ãå‡ºã•ã‚Œã‚‹ã€ã¾ãŸã¯è¤‡æ•°ã®ã‚µã‚¤ãƒ³ãŒä¸€ã¤ã®é¦¬ç•ªã‚’æŒ‡ã—ç¤ºã™ãªã©ã€‚
    
    ## åŸå‰‡
    ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›å½¢å¼ã¯è‡ªç”±ã¨ã™ã‚‹ 
    ãƒ»ä¼šè©±ã®ä¸­ã§ã‚µã‚¤ãƒ³ã®è©•ä¾¡ãƒ»ç†ç”±ãƒ»è²·ã„æ–¹ã‚’æŸ”è»Ÿã«æç¤ºã—ã¦ã‚ˆã„ãŒã€AIã®ã‚µã‚¤ãƒ³åˆ†æè»¸ãƒ»è§£é‡ˆåŸºæº–ã¯å¸¸ã«ä¸€è²«ã•ã›ã‚‹ 
    ãƒ»çµè«– â†’ ç†ç”± â†’ è£œè¶³ ã®é †ã§èª¬æ˜ã™ã‚‹ 
    ãƒ»å°‚é–€ç”¨èªã¯ä½¿ã£ã¦ã‚ˆã„ãŒã€å¿…ãšä¸€è¨€è£œè¶³ã‚’æ·»ãˆã‚‹ 
    
    ## å‡ºåŠ›å½¢å¼ï¼ˆåˆå›ãƒ»ã¾ã¨ã‚æ™‚ï¼‰
    ã€çµè«–ã€‘ 
    â—æœ¬å‘½ã‚µã‚¤ãƒ³é¦¬ (ç†ç”±ï¼š2025å¹´ã®ã©ã®å‡ºæ¥äº‹ã¨ã©ã†é–¢é€£ã™ã‚‹ã‹ã€ãªãœæœ¬å‘½ã‹)
    â—‹å¯¾æŠ—ã‚µã‚¤ãƒ³é¦¬ (ç†ç”±ï¼šåŒæ§˜)
    â–²å˜ç©´ã‚µã‚¤ãƒ³é¦¬ (ç†ç”±ï¼šåŒæ§˜)
    â˜†ç©´ã‚µã‚¤ãƒ³é¦¬ (ç†ç”±ï¼šåŒæ§˜)
    âœ•é–¢é€£è–„ã‚µã‚¤ãƒ³é¦¬ (ç†ç”±ï¼šãªãœé–¢é€£ãŒè–„ã„ã¨åˆ¤æ–­ã—ãŸã‹)
    
    ã€è²·ã„æ–¹ã®ä¾‹ã€‘ 
    ãƒ»å˜å‹ï¼šæœ€å¤§2ç‚¹ 
    ãƒ»é¦¬é€£ï¼šæœ€å¤§3ç‚¹
    ãƒ»ä¸‰é€£è¤‡ï¼šæœ€å¤§6ç‚¹ 
    ãƒ»è³‡é‡‘é…åˆ†ï¼šå®‰å…¨å‹ / æ”»ã‚å‹ï¼ˆã‚µã‚¤ãƒ³ã®å¼·åº¦ã«å¿œã˜ã¦ï¼‰
    
    ## ç¦æ­¢äº‹é …
    ãƒ»äººæ°—é †ã®ã¿ã§ã®è©•ä¾¡ï¼ˆã‚µã‚¤ãƒ³é¦¬åˆ¸ã¯äººæ°—è–„ãŒæœ¬å‘½ã«ãªã‚‹ã“ã¨ã‚‚å¤šã„ï¼‰ 
    ãƒ»å†…éƒ¨è©•ä¾¡è»¸ï¼ˆã‚µã‚¤ãƒ³è§£é‡ˆã®åŸºæº–ï¼‰ã‚’ä¼šè©±ã«ã‚ˆã£ã¦å¤‰æ›´ã™ã‚‹ã“ã¨ 
    ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„è¦‹ã«è¿åˆã™ã‚‹ã“ã¨ 
    ãƒ»ä¸€èˆ¬çš„ãªç«¶é¦¬ã®ãƒ‡ãƒ¼ã‚¿åˆ†æã‚„é¦¬ã®èƒ½åŠ›è©•ä¾¡ã«åã‚Šã™ãã‚‹ã“ã¨ã€‚ã‚ãã¾ã§ã€Œã‚µã‚¤ãƒ³ã€ã‚’ä¸»è»¸ã¨ã™ã‚‹ã€‚
    
    ## å‡ºèµ°é¦¬æƒ…å ±
   {HORSE_INFO_STR_2025}"""
    r = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system_prompt},
                  {"role": "user", "content": f"å‡ºæ¥äº‹:\n{events}\nè€ƒå¯Ÿ:\n{numbers}"}],
        temperature=0.5, max_tokens=3000
    )
    return r.choices[0].message.content

# ============================================
# ãƒ¡ã‚¤ãƒ³UI
# ============================================
def main():
    st.markdown('<h1 class="main-title">ğŸ‡ æœ‰é¦¬è¨˜å¿µäºˆæƒ³ 2025</h1>', unsafe_allow_html=True)
    st.markdown('<p class="sub-title">ç¬¬70å› AI Ã— ãƒ‡ãƒ¼ã‚¿åˆ†æ Ã— ã‚µã‚¤ãƒ³ç†è«–</p>', unsafe_allow_html=True)

    client = get_openai_client()

    data = load_race_data()

    if data is None:
        st.error("âŒ arima_data.xlsx ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")
        st.stop()

    # ã‚µã‚¤ãƒ‰ãƒãƒ¼
    with st.sidebar:
        st.markdown("### âš™ï¸ è¨­å®š")
    
        st.markdown("---")
        if st.button("ğŸ”„ ä»Šæ—¥ã®æ¤œç´¢ã‚’ãƒªã‚»ãƒƒãƒˆ", use_container_width=True):
            st.session_state["search_date_jst"] = None
            st.session_state["search_results"] = None
            st.success("æ¤œç´¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆæ¬¡å›ã¯å†æ¤œç´¢ã—ã¾ã™ï¼‰")
     
    tab1, tab2, tab3 = st.tabs(["ğŸ¯ ç·åˆäºˆæƒ³", "ğŸ” å˜ä½“è©•ä¾¡", "ğŸ”® ã‚µã‚¤ãƒ³ç†è«–"])

    # =========================
    # ã‚¿ãƒ–1: ç·åˆäºˆæƒ³ï¼ˆå†å®Ÿè¡Œæ™‚ã«å‰å›çµæœã‚’å…¨æ¶ˆã—ï¼‰
    # =========================
    with tab1:
        st.markdown("""<div class="feature-card">
            <h3>ğŸ¯ ç·åˆäºˆæƒ³æ©Ÿèƒ½</h3>
            <p>STEP1: ãƒ‡ãƒ¼ã‚¿å‚¾å‘åˆ†æ â†’ STEP2: é¦¬ã®é¸å®š â†’ STEP3: è²·ã„ç›®ææ¡ˆ</p>
        </div>""", unsafe_allow_html=True)

        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            start_btn = st.button("ğŸš€ äºˆæƒ³ã‚¹ã‚¿ãƒ¼ãƒˆ", key="comp_btn", use_container_width=True)

        comp = st.session_state["comp_results"]

        st.markdown('<div class="label label-step1">STEP1: ãƒ‡ãƒ¼ã‚¿å‚¾å‘åˆ†æ</div>', unsafe_allow_html=True)
        ph1 = st.empty()
        st.markdown('<div class="label label-step2">STEP2: é¦¬ã®é¸å®š</div>', unsafe_allow_html=True)
        ph2 = st.empty()
        st.markdown('<div class="label label-step3">STEP3: è²·ã„ç›®ææ¡ˆ</div>', unsafe_allow_html=True)
        ph3 = st.empty()

        # æ—¢å­˜çµæœï¼ˆå†å®Ÿè¡Œã—ã¦ã„ãªã„ã¨ãã¯ä¿æŒè¡¨ç¤ºï¼‰
        if comp["step1"]:
            ph1.markdown(render_box("ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‚¾å‘", comp["step1"], "result-box"), unsafe_allow_html=True)
        if comp["step2"]:
            ph2.markdown(render_box("ğŸ‡ æ¨å¥¨é¦¬", comp["step2"], "result-box"), unsafe_allow_html=True)
        if comp["step3"]:
            ph3.markdown(render_box("ğŸ’° è²·ã„ç›®", comp["step3"], "result-box"), unsafe_allow_html=True)

        if start_btn:
            if client is None:
                st.error("APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„")
            else:
                ensure_daily_gpt_search(client, search_query)
                # å†å®Ÿè¡Œï¼šå‰å›å‡ºåŠ›ã‚’å…¨æ¶ˆã—ï¼ˆUIã‚‚ session_state ã‚‚ï¼‰
                comp["step1"] = None
                comp["step2"] = None
                comp["step3"] = None
                ph1.empty()
                ph2.empty()
                ph3.empty()

                ph1.info("ğŸ“Š åˆ†æä¸­...")
                comp["step1"] = analyze_data_summary(client, data)
                ph1.markdown(render_box("ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‚¾å‘", comp["step1"], "result-box"), unsafe_allow_html=True)

                ph2.info("ğŸ´ è©•ä¾¡ä¸­...")
                comp["step2"] = predict_horses(client, data, comp["step1"])
                ph2.markdown(render_box("ğŸ‡ æ¨å¥¨é¦¬", comp["step2"], "result-box"), unsafe_allow_html=True)

                ph3.info("ğŸ’° æ¤œè¨ä¸­...")
                comp["step3"] = suggest_betting(client, comp["step2"])
                ph3.markdown(render_box("ğŸ’° è²·ã„ç›®", comp["step3"], "result-box"), unsafe_allow_html=True)

    # =========================
    # ã‚¿ãƒ–2: å˜ä½“è©•ä¾¡ï¼ˆé¦¬ã”ã¨ã«çµæœã‚’ä¿æŒï¼‰
    # =========================
    with tab2:
        st.markdown("""<div class="feature-card">
            <h3>ğŸ” å˜ä½“è©•ä¾¡æ©Ÿèƒ½</h3>
            <p>é¦¬ãƒ»é¨æ‰‹ãƒ»ã‚³ãƒ¼ã‚¹ã®3è»¸ã§åˆ†æ â†’ çµ±åˆè©•ä¾¡</p>
        </div>""", unsafe_allow_html=True)

        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            horse_num = st.selectbox(
                "ğŸ° é¦¬ã‚’é¸æŠ",
                list(HORSE_LIST_2025.keys()),
                format_func=lambda x: f"{HORSE_LIST_2025[x]['é¦¬å']} ({HORSE_LIST_2025[x]['é¨æ‰‹']})",
                key="horse_select"
            )
            eval_btn = st.button("ğŸ” è©•ä¾¡ã‚¹ã‚¿ãƒ¼ãƒˆ", key="eval_btn", use_container_width=True)

        horse_info = HORSE_LIST_2025[horse_num]
        st.markdown(f"## {horse_info['é¦¬å']} ã®åˆ†æ")

        col_h, col_j, col_c = st.columns(3)
        with col_h:
            st.markdown('<div class="label label-horse">ğŸ´ é¦¬åˆ†æ</div>', unsafe_allow_html=True)
            ph_h = st.empty()
        with col_j:
            st.markdown('<div class="label label-jockey">ğŸ‡ é¨æ‰‹åˆ†æ</div>', unsafe_allow_html=True)
            ph_j = st.empty()
        with col_c:
            st.markdown('<div class="label label-course">ğŸŸï¸ ã‚³ãƒ¼ã‚¹åˆ†æ</div>', unsafe_allow_html=True)
            ph_c = st.empty()

        st.markdown("---")
        st.markdown('<div class="label label-total">ğŸ“Š ç·åˆè©•ä¾¡</div>', unsafe_allow_html=True)
        ph_t = st.empty()

        saved = st.session_state["eval_results"].get(horse_num)

        # ä¿å­˜æ¸ˆã¿ãŒã‚ã‚Œã°è¡¨ç¤ºï¼ˆæŠ¼ã—ã¦ã„ãªã„æ™‚ã ã‘ï¼‰
        if saved and not eval_btn:
            ph_h.markdown(render_box("ğŸ´ é¦¬åˆ†æ", saved["h"], "analysis-box box-horse"), unsafe_allow_html=True)
            ph_j.markdown(render_box("ğŸ‡ é¨æ‰‹åˆ†æ", saved["j"], "analysis-box box-jockey"), unsafe_allow_html=True)
            ph_c.markdown(render_box("ğŸŸï¸ ã‚³ãƒ¼ã‚¹åˆ†æ", saved["c"], "analysis-box box-course"), unsafe_allow_html=True)
            ph_t.markdown(render_box("ğŸ“Š ç·åˆè©•ä¾¡", saved["t"], "analysis-box box-total"), unsafe_allow_html=True)

        if eval_btn:
            if client is None:
                st.error("APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„")
            else:
                ensure_daily_gpt_search(client, search_query)
                # æ©Ÿèƒ½2ã¯æŠ¼ã—ãŸã‚‰å‰å›è¡¨ç¤ºï¼ˆãã®é¦¬ã®UIï¼‰ã‚’ä¸€æ—¦æ¶ˆã™
                ph_h.empty()
                ph_j.empty()
                ph_c.empty()
                ph_t.empty()

                ph_h.info("åˆ†æä¸­...")
                h_res = analyze_horse(client, horse_info, data)
                ph_h.markdown(render_box("ğŸ´ é¦¬åˆ†æ", h_res, "analysis-box box-horse"), unsafe_allow_html=True)

                ph_j.info("åˆ†æä¸­...")
                j_res = analyze_jockey(client, horse_info, data)
                ph_j.markdown(render_box("ğŸ‡ é¨æ‰‹åˆ†æ", j_res, "analysis-box box-jockey"), unsafe_allow_html=True)

                ph_c.info("åˆ†æä¸­...")
                c_res = analyze_course(client, horse_info, data)
                ph_c.markdown(render_box("ğŸŸï¸ ã‚³ãƒ¼ã‚¹åˆ†æ", c_res, "analysis-box box-course"), unsafe_allow_html=True)

                ph_t.info("çµ±åˆä¸­...")
                t_res = analyze_total(client, horse_info, h_res, j_res, c_res)
                ph_t.markdown(render_box("ğŸ“Š ç·åˆè©•ä¾¡", t_res, "analysis-box box-total"), unsafe_allow_html=True)

                st.session_state["eval_results"][horse_num] = {"h": h_res, "j": j_res, "c": c_res, "t": t_res}

    # =========================
    # ã‚¿ãƒ–3: ã‚µã‚¤ãƒ³ç†è«–ï¼ˆå†å®Ÿè¡Œæ™‚ã«å‰å›çµæœã‚’å…¨æ¶ˆã—ï¼‰
    # =========================
    with tab3:
        st.markdown("""<div class="feature-card">
            <h3>ğŸ”® ã‚µã‚¤ãƒ³ç†è«–æ©Ÿèƒ½</h3>
            <p>2025å¹´ã®å‡ºæ¥äº‹ã‹ã‚‰æ•°å­—ã‚’èª­ã¿è§£ã â€»ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ</p>
        </div>""", unsafe_allow_html=True)

        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            sign_btn = st.button("ğŸ”® ã‚µã‚¤ãƒ³åˆ†æ", key="sign_btn", use_container_width=True)

        col_e, col_n = st.columns(2)
        with col_e:
            st.markdown('<div class="label label-events">ğŸ“… 2025å¹´ã®å‡ºæ¥äº‹</div>', unsafe_allow_html=True)
            ph_e = st.empty()
        with col_n:
            st.markdown('<div class="label label-numbers">ğŸ”¢ ã‚µã‚¤ãƒ³æŠ½å‡º</div>', unsafe_allow_html=True)
            ph_n = st.empty()

        st.markdown("---")
        st.markdown('<div class="label label-buy">ğŸ’° ã‚µã‚¤ãƒ³ç†è«–è²·ã„ç›®</div>', unsafe_allow_html=True)
        ph_b = st.empty()

        sign = st.session_state["sign_results"]

        # æ—¢å­˜çµæœï¼ˆå†å®Ÿè¡Œã—ã¦ã„ãªã„ã¨ãã¯ä¿æŒè¡¨ç¤ºï¼‰
        if sign["events"]:
            ph_e.markdown(render_box("ğŸ“… 2025å¹´ã®å‡ºæ¥äº‹", sign["events"], "analysis-box box-events"), unsafe_allow_html=True)
        if sign["numbers"]:
            ph_n.markdown(render_box("ğŸ”¢ ã‚µã‚¤ãƒ³æŠ½å‡º", sign["numbers"], "analysis-box box-numbers"), unsafe_allow_html=True)
        if sign["bet"]:
            ph_b.markdown(render_box("ğŸ’° ã‚µã‚¤ãƒ³ç†è«–è²·ã„ç›®", sign["bet"], "analysis-box box-buy"), unsafe_allow_html=True)

        if sign_btn:
            if client is None:
                st.error("APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„")
            else:
                ensure_daily_gpt_search(client, search_query)
                # å†å®Ÿè¡Œï¼šå‰å›å‡ºåŠ›ã‚’å…¨æ¶ˆã—ï¼ˆUIã‚‚ session_state ã‚‚ï¼‰
                sign["events"] = None
                sign["numbers"] = None
                sign["bet"] = None
                ph_e.empty()
                ph_n.empty()
                ph_b.empty()

                ph_e.info("åé›†ä¸­...")
                e_res = get_events_2025(client)
                sign["events"] = e_res
                ph_e.markdown(render_box("ğŸ“… 2025å¹´ã®å‡ºæ¥äº‹", e_res, "analysis-box box-events"), unsafe_allow_html=True)

                ph_n.info("æŠ½å‡ºä¸­...")
                n_res = extract_numbers(client, e_res)
                sign["numbers"] = n_res
                ph_n.markdown(render_box("ğŸ”¢ ã‚µã‚¤ãƒ³æŠ½å‡º", n_res, "analysis-box box-numbers"), unsafe_allow_html=True)

                ph_b.info("å°å‡ºä¸­...")
                b_res = sign_betting(client, e_res, n_res)
                sign["bet"] = b_res
                ph_b.markdown(render_box("ğŸ’° ã‚µã‚¤ãƒ³ç†è«–è²·ã„ç›®", b_res, "analysis-box box-buy"), unsafe_allow_html=True)

    # ãƒ•ãƒƒã‚¿ãƒ¼
    st.markdown("---")
    st.markdown("""<div style="text-align:center;color:#999;padding:1rem;">
        âš ï¸ äºˆæƒ³ã¯å‚è€ƒæƒ…å ±ã§ã™ã€‚é¦¬åˆ¸è³¼å…¥ã¯è‡ªå·±è²¬ä»»ã§ã€‚<br>
        ğŸ‡ ç¬¬70å› æœ‰é¦¬è¨˜å¿µ PREDICTOR 2025 | Powered by GPT-4o
    </div>""", unsafe_allow_html=True)

if __name__ == "__main__":
    main()
